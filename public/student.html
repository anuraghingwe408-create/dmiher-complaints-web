<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DMIHER - Student Portal</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Enhanced Animations */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Improved Response Section */
    .response-section {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #bbf7d0;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      animation: slideIn 0.5s ease-out;
    }
    
    .response-item {
      background: white;
      padding: 16px;
      margin: 12px 0;
      border-radius: 8px;
      border-left: 4px solid #059669;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .response-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    /* Enhanced Form Styling */
    .form-card {
      animation: fadeIn 0.6s ease-out;
    }
    
    .form input, .form select, .form textarea {
      transition: all 0.3s ease;
    }
    
    .form input:focus, .form select:focus, .form textarea:focus {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    /* Success/Error Messages */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
    }
    
    .toast.success { background: #059669; }
    .toast.error { background: #ef4444; }
    
    /* Button Enhancements */
    .btn {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    /* Loading Spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="bg-overlay"></div>
  <header class="header container">
    <div class="brand">
      <div class="logo">S</div>
      <div class="brand-text">
        <div class="title">DMIHER</div>
        <div class="subtitle">Student Portal</div>
      </div>
    </div>
    <nav class="nav">
      <button class="btn" id="logoutBtn" type="button">Logout</button>
    </nav>
  </header>
  
  <!-- Main Content -->
  <main id="mainContent" class="container">
    <section class="card form-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h2 id="complaintTitle">Submit a Complaint</h2>
      </div>
      
      <!-- Faculty Response Receipt Section -->
      <div id="facultyResponseReceipt" class="response-section" style="display: none;">
        <h3 style="color: #059669; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          üì® Faculty Responses
        </h3>
        <div id="responseContent"></div>
      </div>
      
      <form id="complaintForm" class="form" autocomplete="off">
        <div class="row">
          <input id="name" name="name" placeholder="Full name" required readonly />
          <input id="email" name="email" type="email" placeholder="Email" required readonly />
        </div>
        <div class="row">
          <input id="course" name="course" placeholder="Course" readonly />
          <input id="studentId" name="studentId" placeholder="Student ID" readonly />
        </div>
        
        <!-- Complaint categories -->
        <div id="complaintCategorySection">
          <label>Complaint Category</label>
          <select id="complaintCategory" name="complaintCategory" class="category-select" required>
            <option value="">Select Category</option>
            <option value="Academic">Academic Issues</option>
            <option value="Infrastructure">Infrastructure</option>
            <option value="Faculty">Faculty Related</option>
            <option value="Administration">Administration</option>
            <option value="Library">Library Services</option>
            <option value="Lab">Lab Facilities</option>
            <option value="Sports">Sports Facilities</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <label>Complaint details</label>
        <textarea id="message" name="message" placeholder="Describe the issue in detail..." required></textarea>

        <label class="file-label">Attach file (Image/PDF) <span class="muted">(optional)</span></label>
        <input type="file" id="attachment" accept=".png,.jpg,.jpeg,.pdf" />

        <div id="previewArea"></div>

        <div class="actions">
          <button class="btn primary" type="submit">Submit Complaint</button>
          <button class="btn" type="button" id="checkResponse">Check Faculty Response</button>
        </div>
      </form>
      
      <!-- Complaint Submission Info -->
      <div style="margin-top: 24px; padding: 16px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border-left: 4px solid #3b82f6;">
        <h4 style="color: #3b82f6; margin-bottom: 8px;">‚ÑπÔ∏è Complaint Process</h4>
        <ul style="font-size: 13px; color: #475569; line-height: 1.5; padding-left: 16px;">
          <li>Your complaint will be reviewed by faculty</li>
          <li>You cannot view or delete your submitted complaints</li>
          <li>Use "Check Faculty Response" to see updates</li>
          <li>Faculty will respond within 3-5 working days</li>
          <li>Download PDF receipt for your records</li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="footer">¬© <span id="year"></span> DMIHER Complaint Registration & Tracking System</footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Check if user is logged in
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const userType = localStorage.getItem('userType');
    
    if (!user || userType !== 'student') {
      // Not logged in or not a student, redirect to login
      window.location.href = 'login.html';
    }
    
    // File attachment handling
    let selectedFile = null;
    
    document.getElementById('attachment').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const previewArea = document.getElementById('previewArea');
      
      if (!file) {
        previewArea.innerHTML = '';
        selectedFile = null;
        return;
      }
      
      // Validate file type
      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf'];
      if (!allowedTypes.includes(file.type)) {
        alert('‚ùå Invalid file type. Only PNG, JPG, JPEG, and PDF files are allowed.');
        e.target.value = '';
        previewArea.innerHTML = '';
        selectedFile = null;
        return;
      }
      
      // Validate file size (5MB max)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('‚ùå File size must be under 5MB.');
        e.target.value = '';
        previewArea.innerHTML = '';
        selectedFile = null;
        return;
      }
      
      // Store file reference
      selectedFile = file;
      
      // Generate preview
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(event) {
          previewArea.innerHTML = `
            <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
              <p style="margin-bottom: 8px; color: #0369a1; font-weight: 500;">üìé File attached: ${file.name}</p>
              <img src="${event.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid #ddd;" />
            </div>
          `;
        };
        reader.readAsDataURL(file);
      } else if (file.type === 'application/pdf') {
        previewArea.innerHTML = `
          <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
            <p style="margin-bottom: 8px; color: #0369a1; font-weight: 500;">üìé File attached: ${file.name}</p>
            <div style="padding: 20px; background: white; border-radius: 4px; text-align: center; border: 1px solid #ddd;">
              <span style="font-size: 48px;">üìÑ</span>
              <p style="margin-top: 8px; color: #6b7280;">${file.name}</p>
            </div>
          </div>
        `;
      }
    });
    
    // Populate form with user data
    document.getElementById('name').value = user.name || '';
    document.getElementById('email').value = user.email || '';
    document.getElementById('course').value = user.dept || user.course || '';
    document.getElementById('studentId').value = user.id || '';
    
    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      localStorage.removeItem('user');
      localStorage.removeItem('userType');
      window.location.href = 'login.html';
    });
    
    // Handle complaint form submission
    document.getElementById('complaintForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        studentId: document.getElementById('studentId').value,
        studentName: document.getElementById('name').value,
        studentEmail: document.getElementById('email').value,
        department: document.getElementById('course').value,
        year: user.year || 'N/A',
        complaintType: document.getElementById('complaintCategory').value,
        subject: document.getElementById('complaintCategory').value,
        description: document.getElementById('message').value
      };
      
      // Handle file attachment if present
      if (selectedFile) {
        try {
          const fileData = await readFileAsBase64(selectedFile);
          formData.attachment = {
            filename: selectedFile.name,
            mimetype: selectedFile.type,
            data: fileData,
            size: selectedFile.size
          };
        } catch (error) {
          alert('‚ùå Failed to read file. Please try again.');
          return;
        }
      }
      
      try {
        console.log('üì§ Submitting complaint...', formData.attachment ? 'with attachment' : 'without attachment');
        
        const response = await fetch('/api/complaints', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        console.log('üì• Response status:', response.status);
        const data = await response.json();
        console.log('üì• Response data:', data);
        
        if (data.success) {
          alert('‚úÖ Complaint submitted successfully! Complaint ID: ' + data.complaint.id);
          document.getElementById('message').value = '';
          document.getElementById('complaintCategory').value = '';
          document.getElementById('attachment').value = '';
          document.getElementById('previewArea').innerHTML = '';
          selectedFile = null;
        } else {
          console.error('‚ùå Server error:', data.error);
          alert('‚ùå Failed to submit complaint: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('‚ùå Error submitting complaint:', error);
        alert('‚ùå Error submitting complaint: ' + error.message + '. Please check console for details.');
      }
    });
    
    // Helper function to read file as Base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          // Extract Base64 data (remove data URL prefix)
          const base64 = event.target.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = function(error) {
          reject(error);
        };
        reader.readAsDataURL(file);
      });
    }
    
    // Download complaint receipt as PDF
    function downloadComplaintReceipt(complaint) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      let yPosition = 20;
      
      // Header
      doc.setFillColor(59, 130, 246);
      doc.rect(0, 0, 210, 40, 'F');
      doc.setFontSize(18);
      doc.setTextColor(255, 255, 255);
      doc.text('DMIHER - Complaint Receipt', 20, 25);
      
      // Reset text color
      doc.setTextColor(0, 0, 0);
      yPosition = 55;
      
      // Receipt details
      doc.setFontSize(11);
      doc.text('Receipt Date: ' + new Date().toLocaleDateString(), 20, yPosition);
      yPosition += 10;
      doc.text('Complaint ID: ' + complaint.id, 20, yPosition);
      yPosition += 10;
      doc.text('Student ID: ' + (complaint.student_id || 'N/A'), 20, yPosition);
      yPosition += 10;
      doc.text('Name: ' + (complaint.student_name || 'N/A'), 20, yPosition);
      yPosition += 10;
      doc.text('Email: ' + (complaint.student_email || 'N/A'), 20, yPosition);
      yPosition += 10;
      doc.text('Course: ' + (complaint.department || 'N/A'), 20, yPosition);
      yPosition += 10;
      doc.text('Submitted: ' + new Date(complaint.created_at).toLocaleString(), 20, yPosition);
      yPosition += 15;
      
      // Complaint details
      doc.setFontSize(13);
      doc.text('Complaint Details:', 20, yPosition);
      yPosition += 8;
      doc.setFontSize(11);
      doc.text('Category: ' + (complaint.complaint_type || 'N/A'), 20, yPosition);
      yPosition += 8;
      const splitMessage = doc.splitTextToSize(complaint.description || 'No details provided', 170);
      doc.text(splitMessage, 20, yPosition);
      yPosition += (splitMessage.length * 6) + 15;
      
      // Attachment info
      if (complaint.attachment && complaint.attachment.filename) {
        doc.setFontSize(11);
        doc.setTextColor(5, 150, 105);
        doc.text('üìé Attachment: ' + complaint.attachment.filename, 20, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += 15;
      }
      
      // Faculty response section
      if (complaint.faculty_response) {
        doc.setFillColor(240, 253, 244);
        doc.rect(20, yPosition, 170, 50, 'F');
        doc.setFontSize(13);
        doc.setTextColor(5, 150, 105);
        doc.text('‚úì Faculty Response:', 25, yPosition + 10);
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        const splitResponse = doc.splitTextToSize(complaint.faculty_response, 160);
        doc.text(splitResponse, 25, yPosition + 20);
        yPosition += 60;
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text('Responded on: ' + new Date(complaint.responded_at).toLocaleString(), 25, yPosition);
        yPosition += 15;
      }
      
      // Footer
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.text('This is an official receipt from DMIHER Complaint System', 20, yPosition + 10);
      doc.text('Generated on: ' + new Date().toLocaleString(), 20, yPosition + 18);
      
      // Save PDF
      doc.save('complaint_receipt_' + complaint.id + '.pdf');
    }
    
    // Check faculty response button
    document.getElementById('checkResponse').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/complaints');
        const complaints = await response.json();
        
        // Filter complaints for current student
        const myComplaints = complaints.filter(c => c.student_email === user.email);
        const repliedComplaints = myComplaints.filter(c => c.faculty_response);
        
        const responseReceipt = document.getElementById('facultyResponseReceipt');
        const responseContent = document.getElementById('responseContent');
        
        if (repliedComplaints.length > 0) {
          responseReceipt.style.display = 'block';
          
          let responseHTML = '';
          repliedComplaints.forEach(complaint => {
            const complaintJson = JSON.stringify(complaint).replace(/"/g, '&quot;');
            
            // Generate attachment preview HTML
            let attachmentHTML = '';
            if (complaint.attachment && complaint.attachment.data) {
              const att = complaint.attachment;
              if (att.mimetype.startsWith('image/')) {
                attachmentHTML = `
                  <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
                    <p style="margin-bottom: 6px; color: #0369a1; font-size: 13px; font-weight: 500;">üìé Your Attachment: ${att.filename}</p>
                    <img src="data:${att.mimetype};base64,${att.data}" style="max-width: 150px; max-height: 100px; border-radius: 4px; border: 1px solid #ddd;" />
                  </div>
                `;
              } else if (att.mimetype === 'application/pdf') {
                attachmentHTML = `
                  <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
                    <p style="margin-bottom: 6px; color: #0369a1; font-size: 13px; font-weight: 500;">üìé Your Attachment: ${att.filename}</p>
                    <div style="padding: 15px; background: white; border-radius: 4px; text-align: center; border: 1px solid #ddd;">
                      <span style="font-size: 32px;">üìÑ</span>
                      <p style="margin-top: 4px; color: #6b7280; font-size: 12px;">${att.filename}</p>
                    </div>
                  </div>
                `;
              }
            }
            
            const attachmentIndicator = complaint.attachment ? ' üìé' : '';
            
            responseHTML += `
              <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #dcfce7;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <strong style="color: #059669;">Complaint ID: ${complaint.id}${attachmentIndicator}</strong>
                  <span style="font-size: 12px; color: #6b7280;">${new Date(complaint.created_at).toLocaleDateString()}</span>
                </div>
                <div style="margin-bottom: 8px;">
                  <strong>Category:</strong> ${complaint.complaint_type}<br>
                  <strong>Your Complaint:</strong> ${complaint.description}
                </div>
                ${attachmentHTML}
                <div style="background: #f0fdf4; padding: 8px; border-radius: 4px; border-left: 3px solid #10b981;">
                  <strong>Faculty Response:</strong> ${complaint.faculty_response}
                </div>
                <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <small style="color: #6b7280;">Responded: ${new Date(complaint.responded_at).toLocaleString()}</small>
                  <button 
                    onclick='downloadComplaintReceipt(${complaintJson})' 
                    style="background: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
                    onmouseover="this.style.background='#059669'" 
                    onmouseout="this.style.background='#10b981'">
                    üì• Download Receipt
                  </button>
                </div>
              </div>
            `;
          });
          
          responseContent.innerHTML = responseHTML;
          alert('‚úÖ Found ' + repliedComplaints.length + ' faculty response(s)');
        } else {
          responseReceipt.style.display = 'none';
          alert('‚ÑπÔ∏è No faculty responses available yet');
        }
      } catch (error) {
        console.error('Error fetching responses:', error);
        alert('‚ùå Error fetching responses. Please try again.');
      }
    });
  </script>
</body>
</html>
